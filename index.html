<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kybra Market - Inscription & Avis</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f4f8; margin:0; padding:0;}
  .container { max-width: 500px; margin: 50px auto; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);}
  h2 { text-align: center; color: #2c3e50; }
  form { display: flex; flex-direction: column; }
  input, select, textarea, button { margin: 10px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
  button { background: #2ecc71; color: white; border: none; cursor: pointer; }
  button:hover { background: #27ae60; }
  .google-btn { background: #4285F4; margin-top: 0; }
</style>
</head>
<body>

<div class="container">
  <h2>Inscription Kybra</h2>
  <form id="signupForm">
    <input type="text" id="firstName" placeholder="Prénom" required>
    <input type="text" id="lastName" placeholder="Nom" required>
    <label>Date de naissance:</label>
    <input type="date" id="dob" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Mot de passe" required>
    <button type="submit">S'inscrire</button>
  </form>

  <h2>Connexion</h2>
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email" required>
    <input type="password" id="loginPassword" placeholder="Mot de passe" required>
    <button type="submit">Connexion</button>
  </form>
  <button id="googleLogin" class="google-btn">Connexion avec Google</button>

  <h2>Laisser un avis</h2>
  <form id="reviewForm">
    <input type="text" id="reviewName" placeholder="Votre prénom" required>
    <label>Note (1 à 5)</label>
    <select id="reviewNote" required>
      <option value="">Choisir</option>
      <option value="1">1 ⭐</option>
      <option value="2">2 ⭐⭐</option>
      <option value="3">3 ⭐⭐⭐</option>
      <option value="4">4 ⭐⭐⭐⭐</option>
      <option value="5">5 ⭐⭐⭐⭐⭐</option>
    </select>
    <textarea id="reviewComment" placeholder="Votre avis..." required></textarea>
    <button type="submit">Envoyer avis</button>
  </form>
</div>

<script type="module">
  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBbS1iBrL9Hkscvj8wermWwr9ZwIa1KNFE",
    authDomain: "kybra-auth.firebaseapp.com",
    projectId: "kybra-auth",
    storageBucket: "kybra-auth.firebasestorage.app",
    messagingSenderId: "478739816057",
    appId: "1:478739816057:web:9799c9d11067d67a66bea8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Calcul âge
  function calculateAge(dob) {
    const birthDate = new Date(dob);
    const diff = Date.now() - birthDate.getTime();
    const ageDate = new Date(diff);
    return Math.abs(ageDate.getUTCFullYear() - 1970);
  }

  // Inscription
  document.getElementById("signupForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const firstName = document.getElementById("firstName").value;
    const lastName = document.getElementById("lastName").value;
    const dob = document.getElementById("dob").value;
    const age = calculateAge(dob);
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      await addDoc(collection(db, "users"), {
        firstName, lastName, age, email
      });
      alert(`✅ Inscription réussie, bienvenue ${firstName} !`);
      document.getElementById("signupForm").reset();
    } catch(err) {
      console.error(err);
      alert("❌ Erreur lors de l'inscription : " + err.message);
    }
  });

  // Connexion
  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      alert("✅ Connexion réussie !");
      document.getElementById("loginForm").reset();
    } catch(err) {
      console.error(err);
      alert("❌ Erreur lors de la connexion : " + err.message);
    }
  });

  // Connexion Google
  document.getElementById("googleLogin").addEventListener("click", async ()=>{
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      await addDoc(collection(db, "users"), {
        firstName: user.displayName || "Utilisateur Google",
        email: user.email
      });
      alert(`✅ Bienvenue ${user.displayName || "Utilisateur"} !`);
    } catch(err) {
      console.error(err);
      alert("❌ Erreur Google : " + err.message);
    }
  });

  // Avis
  document.getElementById("reviewForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const firstName = document.getElementById("reviewName").value;
    const note = document.getElementById("reviewNote").value;
    const commentaire = document.getElementById("reviewComment").value;

    try {
      await addDoc(collection(db, "avis"), {
        firstName, note, commentaire
      });
      alert(`Merci ${firstName} pour ton avis !`);
      document.getElementById("reviewForm").reset();
    } catch(err) {
      console.error(err);
      alert("❌ Erreur lors de l'envoi de l'avis : " + err.message);
    }
  });

</script>
</body>
</html>
